<script>
    let provider, signer, contract;
    const contractAddress = "0xYourContractAddressHere";
    const abi = [
      {
        "inputs": [
          {"internalType": "address", "name": "account", "type": "address"},
          {"internalType": "uint8", "name": "role", "type": "uint8"},
          {"internalType": "bool", "name": "status", "type": "bool"}
        ],
        "name": "setParticipant",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
        "name": "getParticipantRole",
        "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [{"internalType": "string", "name": "lotId", "type": "string"}],
        "name": "getTransferHistory",
        "outputs": [{
          "components": [
            {"internalType": "address", "name": "from", "type": "address"},
            {"internalType": "address", "name": "to", "type": "address"},
            {"internalType": "uint256", "name": "date", "type": "uint256"}
          ],
          "internalType": "struct SupplyChain.Transfer[]",
          "name": "",
          "type": "tuple[]"
        }],
        "stateMutability": "view",
        "type": "function"
      }
    ];
  
    async function connectWallet() {
      if (window.ethereum) {
        try {
          // Indiquer visuellement que la connexion est en cours
          document.getElementById('wallet-address').innerText = "Connexion en cours...";
          provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, abi, signer);
          const userAddress = await signer.getAddress();
          document.getElementById('wallet-address').innerText = "Connecté : " + userAddress;
        } catch (error) {
          document.getElementById('wallet-address').innerText = "Erreur lors de la connexion";
          console.error(error);
        }
      } else {
        alert("Veuillez installer MetaMask");
      }
    }
  
    async function setRole() {
      const address = document.getElementById("participantAddress").value.trim();
      const role = document.getElementById("participantRole").value;
      
      // Validation de l'adresse Ethereum
      if (!ethers.utils.isAddress(address)) {
        alert("Adresse Ethereum invalide !");
        return;
      }
      
      try {
        // Désactiver le bouton pour éviter les appels multiples
        const btn = document.querySelector("button[onclick='setRole()']");
        btn.disabled = true;
        const tx = await contract.setParticipant(address, role, true);
        await tx.wait();
        alert("Rôle assigné avec succès");
      } catch (err) {
        alert("Erreur : " + err.message);
        console.error(err);
      } finally {
        // Réactiver le bouton
        const btn = document.querySelector("button[onclick='setRole()']");
        btn.disabled = false;
      }
    }
  
    async function getRole() {
      const address = document.getElementById("roleCheckAddress").value.trim();
      
      // Validation de l'adresse Ethereum
      if (!ethers.utils.isAddress(address)) {
        alert("Adresse Ethereum invalide !");
        return;
      }
      
      try {
        const role = await contract.getParticipantRole(address);
        const roles = ["Aucun", "Fabricant", "Transporteur", "Revendeur", "Client"];
        document.getElementById("roleResult").innerText = `Rôle de ${address} : ${roles[role] || "Inconnu"}`;
      } catch (err) {
        alert("Erreur : " + err.message);
        console.error(err);
      }
    }
  
    async function showHistory() {
      const lotId = document.getElementById("historyLotId").value.trim();
      if (lotId === "") {
        alert("Veuillez saisir un Lot ID");
        return;
      }
      
      try {
        // Optionnel : Indiquer le chargement de l'historique
        const list = document.getElementById("historyList");
        list.innerHTML = "<li>Chargement...</li>";
        const history = await contract.getTransferHistory(lotId);
        list.innerHTML = '';
        if (history.length === 0) {
          list.innerHTML = "<li>Aucun transfert trouvé pour ce Lot ID</li>";
          return;
        }
        history.forEach(h => {
          const li = document.createElement("li");
          li.innerText = `De ${h.from} à ${h.to} le ${new Date(h.date * 1000).toLocaleString()}`;
          list.appendChild(li);
        });
      } catch (err) {
        alert("Erreur : " + err.message);
        console.error(err);
      }
    }
  </script>